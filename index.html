<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u PCCC Pro - QCVN 06:2022 (Sƒê 1:2023)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #b91c1c;
            --sidebar-bg: #1e1f20;
            --sidebar-text: #e3e3e3;
            --bg: #ffffff;
            --card: #f0f4f9;
            --text: #1f1f1f;
            --border: #e5e7eb;
            --highlight: #fde047;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        
        .brand {
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #c4c7c5;
            border-radius: 0 20px 20px 0;
            margin-right: 10px;
        }
        .menu-item:hover { background-color: #333; color: #fff; }
        .menu-item.active { background-color: #004a77; color: #c2e7ff; font-weight: 500; }
        .highlight-menu { color: #fbbf24 !important; font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            padding: 20px 40px;
            overflow-y: auto;
            background: #fff;
        }

        .section { display: none; max-width: 950px; margin: 0 auto; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT CARD */
        .card {
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-section-title {
            grid-column: 1 / -1;
            font-size: 12px;
            font-weight: 700;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #3c4043; }
        input, select {
            width: 100%; padding: 10px;
            border: 1px solid #dadce0; border-radius: 4px;
            font-size: 14px; transition: 0.2s;
        }
        input:focus, select:focus { border-color: #1a73e8; outline: 2px solid rgba(26,115,232,0.2); }

        .btn {
            background: #0b57d0; color: #fff;
            padding: 12px; border: none; border-radius: 24px;
            font-weight: 500; cursor: pointer; width: 100%;
            transition: background 0.2s;
        }
        .btn:hover { background: #0842a0; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* --- REPORT STYLES --- */
        .report-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .report-title { font-size: 16px; font-weight: 600; color: #1f1f1f; }
        .status-badge { font-size: 12px; padding: 4px 12px; border-radius: 16px; font-weight: 500; }
        .st-ok { background: #e6f4ea; color: #137333; }
        .st-warn { background: #fef7e0; color: #ea8600; }
        .st-err { background: #fce8e6; color: #c5221f; }

        .calc-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #444746;
            border-left: 3px solid #0b57d0;
            margin-bottom: 12px;
        }

        .citation-trigger {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f1f3f4;
            border-radius: 18px;
            font-size: 12px;
            color: #1f1f1f;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .citation-trigger:hover { background: #e8eaed; border-color: #dadce0; }
        .citation-trigger svg { width: 16px; height: 16px; fill: #5f6368; }

        /* --- DOCUMENT VIEWER MODAL (GEMINI STYLE) --- */
        .doc-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        
        .doc-modal {
            background: #f0f2f5;
            width: 95%; max-width: 1100px; height: 95vh;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        .doc-header {
            background: #fff;
            padding: 12px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .doc-title { font-weight: 600; color: #444746; font-size: 14px; }
        .close-btn { cursor: pointer; padding: 8px; border-radius: 50%; border: none; background: none; }
        .close-btn:hover { background: #f1f3f4; }

        .doc-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            background: #525659; /* M√†u n·ªÅn gi·ªëng tr√¨nh ƒë·ªçc PDF */
        }

        /* GROUP OF PAGES FOR ONE BASIS */
        .citation-group {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 40px;
            border-bottom: 2px dashed #777;
        }
        
        .citation-group-title {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            background: #333;
            padding: 8px 16px;
            border-radius: 4px;
            align-self: flex-start;
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* TRANG GI·∫§Y GI·∫¢ L·∫¨P */
        .doc-page {
            background: #fff;
            width: 100%; 
            min-height: 1000px; /* T·ª∑ l·ªá A4 */
            padding: 50px 60px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
            font-family: 'Merriweather', serif; /* Font gi·ªëng vƒÉn b·∫£n in */
            font-size: 14px;
            line-height: 1.6;
            color: #202124;
            position: relative;
        }

        .doc-page-number {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            font-size: 12px; color: #9aa0a6; font-family: sans-serif;
        }
        
        .doc-page-header-text {
            position: absolute; top: 30px; right: 60px;
            font-size: 10px; color: #9aa0a6; text-transform: uppercase; font-family: sans-serif;
        }

        .page-label {
            position: absolute; top: -25px; left: 0;
            background: #444; color: #fff;
            padding: 4px 8px; border-radius: 4px 4px 0 0;
            font-size: 11px; font-family: sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-label.is-center { background: #b91c1c; font-weight: bold; }

        /* HIGHLIGHT STYLES */
        mark.highlight {
            background-color: rgba(253, 224, 71, 0.6); /* V√†ng nh·∫°t */
            color: #000;
            padding: 2px 0;
            border-bottom: 2px solid #f59e0b; /* G·∫°ch ch√¢n ƒë·∫≠m */
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: visible; }
            .sidebar { width: 100%; height: auto; }
            .main-content { padding: 15px; }
            .doc-body { padding: 10px; }
            .doc-page { padding: 20px; min-height: auto; }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="brand"><span>üî•</span> PCCC PRO</div>
    
    <div style="padding: 15px 20px 5px; font-size: 11px; font-weight: 700; color: #8e918f;">C√îNG C·ª§ CH√çNH</div>
    <div class="menu-item active highlight-menu" onclick="showTab('tong-hop', this)">üìã T·ªïng h·ª£p & Ki·ªÉm tra</div>

    <div style="padding: 15px 20px 5px; font-size: 11px; font-weight: 700; color: #8e918f;">TRA C·ª®U NHANH</div>
    <div class="menu-item" onclick="showTab('nhom-nha', this)">üîç Nh√≥m nh√† (F)</div>
    <div class="menu-item" onclick="showTab('bac-chiu-lua', this)">üèóÔ∏è B·∫≠c Ch·ªãu L·ª≠a</div>
    <div class="menu-item" onclick="showTab('cau-kien', this)">üß± C·∫•u ki·ªán (B·∫£ng 1)</div>
    <div class="menu-item" onclick="showTab('thoat-nan', this)">üèÉ Tho√°t n·∫°n</div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

    <!-- DASHBOARD T·ªîNG H·ª¢P -->
    <div id="tong-hop" class="section active">
        <h2 style="margin-top:0">Ki·ªÉm tra & T√≠nh to√°n PCCC</h2>
        
        <div class="card">
            <div class="form-grid">
                <!-- 1. QUY M√î -->
                <div>
                    <div class="form-section-title">1. Quy m√¥ c√¥ng tr√¨nh</div>
                    <label>Chi·ªÅu cao PCCC (m):</label>
                    <input type="number" id="inp-height" placeholder="VD: 18.5">
                    <div style="margin-top:10px"><label>S·ªë t·∫ßng n·ªïi:</label>
                    <input type="number" id="inp-floors" placeholder="VD: 5"></div>
                    <div style="margin-top:10px"><label>Di·ªán t√≠ch s√†n max (m¬≤):</label>
                    <input type="number" id="inp-area" placeholder="VD: 800"></div>
                </div>

                <!-- 2. C√îNG NƒÇNG -->
                <div>
                    <div class="form-section-title">2. C√¥ng nƒÉng & S·ª≠ d·ª•ng</div>
                    <label>Lo·∫°i c√¥ng tr√¨nh:</label>
                    <select id="inp-function" onchange="toggleRiskInput()">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="F1.3">F1.3 - Chung c∆∞</option>
                        <option value="F4.3">F4.3 - VƒÉn ph√≤ng</option>
                        <option value="F3.1">F3.1 - Th∆∞∆°ng m·∫°i</option>
                        <option value="F5.1">F5.1 - Nh√† x∆∞·ªüng</option>
                        <option value="F1.2">F1.2 - Kh√°ch s·∫°n</option>
                    </select>
                    <div id="risk-container" style="display:none; margin-top:10px">
                        <label>H·∫°ng s·∫£n xu·∫•t (F5):</label>
                        <select id="inp-risk">
                            <option value="C">H·∫°ng C</option>
                            <option value="A">H·∫°ng A</option>
                            <option value="B">H·∫°ng B</option>
                            <option value="D">H·∫°ng D</option>
                            <option value="E">H·∫°ng E</option>
                        </select>
                    </div>
                    <!-- Auto Grade Display -->
                    <div style="margin-top:15px; padding:10px; background:#e8f0fe; border-radius:6px; font-size:13px; border: 1px solid #d2e3fc;">
                        <span style="color:#1967d2; font-weight:bold">T·ª± ƒë·ªông x√°c ƒë·ªãnh:</span><br>
                        B·∫≠c ch·ªãu l·ª≠a y√™u c·∫ßu: <span id="auto-grade-display" style="font-weight:bold; color:#b91c1c">...</span>
                    </div>
                </div>

                <!-- 3. THO√ÅT N·∫†N -->
                <div>
                    <div class="form-section-title">3. Tho√°t n·∫°n (T√≠nh to√°n)</div>
                    <label>T·ªïng s·ªë ng∆∞·ªùi (t·∫ßng ƒë√¥ng nh·∫•t):</label>
                    <input type="number" id="inp-people" placeholder="VD: 150">
                </div>

                <!-- 4. V·ªä TR√ç -->
                <div>
                    <div class="form-section-title">4. Kho·∫£ng c√°ch an to√†n</div>
                    <label>Kho·∫£ng c√°ch t·ªõi nh√† b√™n c·∫°nh (m):</label>
                    <input type="number" id="inp-dist" placeholder="VD: 6">
                    <div style="margin-top:10px">
                        <label>B·∫≠c ch·ªãu l·ª≠a nh√† b√™n c·∫°nh:</label>
                        <select id="inp-neighbor-grade">
                            <option value="1">B·∫≠c I, II</option>
                            <option value="2">B·∫≠c III</option>
                            <option value="3">B·∫≠c IV, V</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="runCheckAll()">T√çNH TO√ÅN & HI·ªÇN TH·ªä CƒÇN C·ª®</button>
        </div>

        <div id="report-container" style="display:none">
            <!-- Results rendered here -->
        </div>
    </div>

    <!-- Placeholders for other tabs -->
    <div id="nhom-nha" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u nh√≥m nh√†...</div></div>
    <div id="bac-chiu-lua" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u b·∫≠c ch·ªãu l·ª≠a...</div></div>
    <div id="cau-kien" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u c·∫•u ki·ªán...</div></div>
    <div id="thoat-nan" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u tho√°t n·∫°n...</div></div>
</div>

<!-- DOCUMENT VIEWER MODAL -->
<div id="doc-modal" class="doc-modal-overlay">
    <div class="doc-modal">
        <div class="doc-header">
            <div class="doc-title">üìÑ QCVN 06:2022/BXD - TR√åNH XEM CƒÇN C·ª® PH√ÅP L√ù</div>
            <button class="close-btn" onclick="closeDocViewer()">‚úï</button>
        </div>
        <div class="doc-body" id="doc-viewer-content">
            <!-- Pages will be injected here -->
        </div>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
    // --- DATABASE VƒÇN B·∫¢N G·ªêC (GI·∫¢ L·∫¨P C√ÅC TRANG) ---
    const qcvnPages = {
        // --- NH√ìM THO√ÅT N·∫†N (37-41) ---
        37: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p>C√°c quy ƒë·ªãnh chung v·ªÅ tho√°t n·∫°n...</p><p>3.1. L·ªëi tho√°t n·∫°n l√† l·ªëi ƒëi...</p><p>3.2. C√°c l·ªëi ra tho√°t n·∫°n...</p>`,
        38: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.2.3.</strong> C√°c l·ªëi ra t·ª´ t·∫ßng h·∫ßm v√† t·∫ßng n·ª≠a h·∫ßm l√† l·ªëi ra tho√°t n·∫°n khi tho√°t tr·ª±c ti·∫øp ra ngo√†i...</p><p><strong>3.2.4.</strong> Chi·ªÅu r·ªông t·ªïng c·ªông c·ªßa v·∫ø thang, l·ªëi ƒëi tr√™n ƒë∆∞·ªùng tho√°t n·∫°n... ph·∫£i ƒë∆∞·ª£c x√°c ƒë·ªãnh t√πy thu·ªôc v√†o s·ªë l∆∞·ª£ng ng∆∞·ªùi... nh∆∞ng kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n gi√° tr·ªã quy ƒë·ªãnh:</p><ul style="list-style-type: disc; margin-left: 20px;"><li>Nh√† F1.1: <strong>1,25m</strong> (n·∫øu ‚â• 3 t·∫ßng)</li><li>Nh√† F1.2, F2, F3, F4: <strong>1,00m</strong> (t·∫ßng m·∫∑t ƒë·∫•t), <strong>0,80m</strong> (c√°c t·∫ßng kh√°c)</li><li>Nh√† kh√°n ƒë√†i, r·∫°p h√°t: <strong>0,60m</strong></li></ul>`,
        39: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.4.1.</strong> Chi·ªÅu r·ªông th·ªßy c·ªßa b·∫£n thang b·ªô, chi·∫øu ngh·ªâ... ph·∫£i ƒë∆∞·ª£c t√≠nh to√°n v√† kh√¥ng nh·ªè h∆°n gi√° tr·ªã quy ƒë·ªãnh d∆∞·ªõi ƒë√¢y:</p><p>a) Chi·ªÅu r·ªông c·ªßa c√°c l·ªëi ra tho√°t n·∫°n (c·ª≠a ƒëi)... ph·∫£i kh√¥ng nh·ªè h∆°n:</p><p>- 1,2 m ƒë·ªëi v·ªõi h√†nh lang, b·∫£n thang d√πng ƒë·ªÉ tho√°t n·∫°n cho h∆°n 15 ng∆∞·ªùi thu·ªôc nh√≥m F1.1;</p><p>- <strong>1,0 m</strong> trong t·∫•t c·∫£ c√°c tr∆∞·ªùng h·ª£p c√≤n l·∫°i.</p><p>b) Chi·ªÅu r·ªông c·ªßa c√°c v·∫ø thang b·ªô d√πng ƒë·ªÉ tho√°t n·∫°n...:</p><p>- <strong>0,9 m</strong> ƒë·ªëi v·ªõi c√°c tr∆∞·ªùng h·ª£p kh√°c.</p>`,
        40: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.4.2.</strong> Chi·ªÅu r·ªông c·ªßa m·∫∑t b·∫≠c thang kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n 25 cm, c√≤n chi·ªÅu cao c·ªßa b·∫≠c thang kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n 22 cm.</p><p>ƒê·ªô d·ªëc c·ªßa c√°c c·∫ßu thang b·ªô tr√™n c√°c ƒë∆∞·ªùng tho√°t n·∫°n kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n 1:1...</p>`,
        41: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.4.4.</strong> C√°c l·ªëi ra tho√°t n·∫°n ph·∫£i ƒë∆∞·ª£c b·ªë tr√≠ ph√¢n t√°n...</p>`,

        // --- NH√ìM B·∫¨C CH·ªäU L·ª¨A (103-107) ---
        103: `<h4 style="text-align:center">PH·ª§ L·ª§C H</h4><p>B·∫£ng H.1 - S·ªë t·∫ßng gi·ªõi h·∫°n v√† di·ªán t√≠ch khoang ch√°y c·ªßa nh√† tr·∫ª, tr∆∞·ªùng m·∫´u gi√°o...</p>`,
        104: `<h4 style="text-align:center">PH·ª§ L·ª§C H (Quy ƒë·ªãnh)</h4><p><strong>B·∫£ng H.3 - S·ªë t·∫ßng gi·ªõi h·∫°n v√† di·ªán t√≠ch khoang ch√°y c·ªßa nh√† c√¥ng c·ªông, nh√† s·∫£n xu·∫•t, nh√† kho</strong></p><table border="1" style="width:100%; border-collapse:collapse;"><tr><th>B·∫≠c ch·ªãu l·ª≠a</th><th>C·∫•p nguy hi·ªÉm KC</th><th>Chi·ªÅu cao PCCC (m)</th><th>Di·ªán t√≠ch khoang ch√°y (m2)</th></tr><tr><td>I</td><td>S0</td><td><= 50</td><td>2500</td></tr><tr><td>II</td><td>S0</td><td><= 50</td><td>2500</td></tr><tr><td>III</td><td>S0</td><td><= 28</td><td>1200</td></tr></table>`,
        105: `<h4 style="text-align:center">PH·ª§ L·ª§C H (Ti·∫øp theo)</h4><p><strong>B·∫£ng H.4 - S·ªë t·∫ßng gi·ªõi h·∫°n v√† di·ªán t√≠ch khoang ch√°y c·ªßa nh√† chung c∆∞, nh√† k√Ω t√∫c x√° (F1.2, F1.3)</strong></p><table border="1" cellpadding="5" style="width:100%; border-collapse:collapse; margin-top:10px;"><tr style="background:#eee"><th>B·∫≠c ch·ªãu l·ª≠a</th><th>C·∫•p nguy hi·ªÉm ch√°y KC</th><th>Chi·ªÅu cao PCCC t·ªëi ƒëa (m)</th><th>Di·ªán t√≠ch khoang ch√°y t·ªëi ƒëa (m2)</th></tr><tr><td>I</td><td>S0</td><td><= 75</td><td>2500</td></tr><tr><td>II</td><td>S0</td><td><= 50</td><td>2500</td></tr><tr><td>III</td><td>S0</td><td><= 28</td><td>1800</td></tr></table>`,
        106: `<h4 style="text-align:center">PH·ª§ L·ª§C H (Ti·∫øp theo)</h4><p>Ghi ch√∫ chung cho Ph·ª• l·ª•c H:</p><p>- Khi nh√† ƒë∆∞·ª£c trang b·ªã h·ªá th·ªëng ch·ªØa ch√°y t·ª± ƒë·ªông, di·ªán t√≠ch khoang ch√°y cho ph√©p ƒë∆∞·ª£c tƒÉng l√™n 100%.</p>`,
        107: `<h4 style="text-align:center">PH·ª§ L·ª§C I</h4><p>Kho·∫£ng c√°ch ph√≤ng ch√°y ch·ªëng ch√°y...</p>`
    };

    // --- H√ÄM LOGIC CH√çNH ---
    function runCheckAll() {
        const inputs = {
            h: parseFloat(document.getElementById('inp-height').value) || 0,
            f: parseInt(document.getElementById('inp-floors').value) || 0,
            area: parseFloat(document.getElementById('inp-area').value) || 0,
            people: parseInt(document.getElementById('inp-people').value) || 0,
            func: document.getElementById('inp-function').value,
            dist: parseFloat(document.getElementById('inp-dist').value) || 0,
            nGrade: document.getElementById('inp-neighbor-grade').value
        };

        if (!inputs.func || !inputs.h) {
            alert("Vui l√≤ng nh·∫≠p C√¥ng nƒÉng v√† Chi·ªÅu cao!");
            return;
        }

        const report = document.getElementById('report-container');
        report.style.display = 'block';
        report.innerHTML = ''; 

        // 1. T√çNH B·∫¨C CH·ªäU L·ª¨A
        const autoGrade = calculateFireGrade(inputs);
        document.getElementById('auto-grade-display').textContent = `B·∫≠c ${autoGrade.grade}`;
        
        // Render Card 1
        renderReportCard(report, '1. X√°c ƒë·ªãnh B·∫≠c ch·ªãu l·ª≠a & Quy m√¥', autoGrade.status, `
            <div class="report-row"><span class="report-label">Chi·ªÅu cao:</span> <span class="report-val">${inputs.h} m</span></div>
            <div class="report-row"><span class="report-label">C√¥ng nƒÉng:</span> <span class="report-val">${inputs.func}</span></div>
            <div class="calc-box">
                ‚Üí Tra B·∫£ng H.4 (Ph·ª• l·ª•c H) cho Chung c∆∞ / H.3 cho c√¥ng nƒÉng kh√°c<br>
                ‚Üí K·∫øt lu·∫≠n: <strong>B·∫¨C ${autoGrade.grade}</strong>
            </div>
        `, [
            // Citation object array
            { page: 105, label: 'B·∫£ng H.4 (ƒê·ªëi chi·∫øu F1.3)', highlights: ["F1.3", "B·∫≠c "+autoGrade.grade, "2500", inputs.h > 50 ? "75" : "50"] },
            { page: 106, label: 'Ghi ch√∫ Ph·ª• l·ª•c H (TƒÉng di·ªán t√≠ch)', highlights: ["ch·ªØa ch√°y t·ª± ƒë·ªông", "tƒÉng l√™n 100%"] }
        ]);

        // 2. T√çNH THO√ÅT N·∫†N
        if (inputs.people > 0) {
            const egress = calculateEgress(inputs.people, inputs.func);
            
            renderReportCard(report, '2. T√≠nh to√°n Tho√°t n·∫°n (Chi ti·∫øt)', 'ok', `
                <div class="report-row"><span class="report-label">S·ªë ng∆∞·ªùi:</span> <span class="report-val">${inputs.people}</span></div>
                <div class="calc-box">
                    1. T√≠nh theo m·∫≠t ƒë·ªô (M·ª•c 3.2.4):<br>
                    ${inputs.people} / 100 = <strong>${egress.widthCalc} m</strong><br><br>
                    2. So s√°nh v·ªõi t·ªëi thi·ªÉu (M·ª•c 3.4.1):<br>
                    Y√™u c·∫ßu c·ª≠a: <strong>${egress.minAllowed} m</strong><br><br>
                    3. K·∫øt lu·∫≠n: Ch·ªçn <strong>${egress.finalWidth} m</strong>
                </div>
            `, [
                // MULTIPLE CITATIONS FOR EGRESS
                { page: 38, label: 'M·ª•c 3.2.4 (M·∫≠t ƒë·ªô d√≤ng ng∆∞·ªùi)', highlights: ["100 ng∆∞·ªùi", "1,00m", "0,80m"] },
                { page: 39, label: 'M·ª•c 3.4.1 (Chi·ªÅu r·ªông t·ªëi thi·ªÉu)', highlights: ["1,0 m", "0,9 m", "1,2 m"] }
            ]);
        }
    }

    // --- DOCUMENT VIEWER LOGIC (MULTI-PAGE SUPPORT) ---
    function openDocViewer(citations) {
        // citations is an array of objects: [{page: 38, label: '...', highlights: []}, ...]
        const modal = document.getElementById('doc-modal');
        const content = document.getElementById('doc-viewer-content');
        
        content.innerHTML = '';

        citations.forEach((cit, idx) => {
            const centerPage = cit.page;
            // Render Group Container
            const groupDiv = document.createElement('div');
            groupDiv.className = 'citation-group';
            
            // Header for the basis
            const titleDiv = document.createElement('div');
            titleDiv.className = 'citation-group-title';
            titleDiv.innerText = `CƒÇN C·ª® ${idx + 1}: ${cit.label}`;
            groupDiv.appendChild(titleDiv);

            // Pages: center-1, center, center+1
            const pagesToRender = [centerPage - 1, centerPage, centerPage + 1];

            pagesToRender.forEach((pageNum, pIdx) => {
                const pageData = qcvnPages[pageNum] || `<div style="text-align:center; padding-top:100px; color:#999;">(N·ªôi dung trang ${pageNum} ƒëang c·∫≠p nh·∫≠t...)</div>`;
                
                const pageDiv = document.createElement('div');
                pageDiv.className = 'doc-page';
                
                // Labels
                let labelText = '';
                let labelClass = 'page-label';
                if (pIdx === 0) labelText = `TRANG TR∆Ø·ªöC (${pageNum})`;
                if (pIdx === 1) { labelText = `TRANG CƒÇN C·ª® (${pageNum})`; labelClass += ' is-center'; }
                if (pIdx === 2) labelText = `TRANG SAU (${pageNum})`;

                // Highlighting (Only for center page)
                let processedContent = pageData;
                if (pIdx === 1 && cit.highlights && cit.highlights.length > 0) {
                    cit.highlights.forEach(keyword => {
                        try {
                            // Simple replace, caution with HTML tags in production
                            const regex = new RegExp(`(${keyword})`, 'gi');
                            processedContent = processedContent.replace(regex, '<mark class="highlight">$1</mark>');
                        } catch(e) {}
                    });
                }

                pageDiv.innerHTML = `
                    <div class="${labelClass}">${labelText}</div>
                    <div class="doc-page-header-text">QCVN 06:2022/BXD - B·ªò X√ÇY D·ª∞NG</div>
                    ${processedContent}
                    <div class="doc-page-number">Trang ${pageNum}</div>
                `;
                groupDiv.appendChild(pageDiv);
            });

            content.appendChild(groupDiv);
        });

        modal.style.display = 'flex';
    }

    function closeDocViewer() {
        document.getElementById('doc-modal').style.display = 'none';
    }

    // --- HELPER LOGIC ---
    function calculateFireGrade(inp) {
        let g = 'III';
        if (inp.h > 50) g = 'I';
        else if (inp.h > 28) g = 'II';
        return { grade: g, status: 'ok' };
    }

    function calculateEgress(people, func) {
        let factor = 100;
        let minW = 1.0;
        if (func === 'F1.1') minW = 1.2;
        
        let wCalc = people / factor;
        let wFinal = Math.max(wCalc, minW);
        return { widthCalc: wCalc.toFixed(2), minAllowed: minW, finalWidth: wFinal.toFixed(2) };
    }

    // Updated renderReportCard to accept citations array
    function renderReportCard(container, title, status, contentHTML, citations) {
        const statusClass = status === 'ok' ? 'st-ok' : (status === 'err' ? 'st-err' : 'st-warn');
        const statusText = status === 'ok' ? 'ƒê·∫†T / ƒê√É T√çNH' : 'L∆ØU √ù';
        
        // Serialize citations for onClick
        const citString = JSON.stringify(citations).replace(/"/g, "&quot;");

        const html = `
            <div class="report-card">
                <div class="report-header">
                    <div class="report-title">${title}</div>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                </div>
                <div>${contentHTML}</div>
                <div style="margin-top:12px; border-top:1px solid #f0f0f0; padding-top:10px;">
                    <div class="citation-trigger" onclick="openDocViewer(${citString})">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        <span>Xem cƒÉn c·ª© ph√°p l√Ω chi ti·∫øt (${citations.length} m·ª•c)</span>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function showTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }
    function toggleRiskInput() {
        const f = document.getElementById('inp-function').value;
        document.getElementById('risk-container').style.display = f.startsWith('F5') ? 'block' : 'none';
    }
</script>

</body>
</html>
