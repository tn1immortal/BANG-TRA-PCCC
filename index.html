<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u PCCC Pro - QCVN 06:2022 (Sƒê 1:2023)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #b91c1c;
            --sidebar-bg: #1e1f20;
            --sidebar-text: #e3e3e3;
            --bg: #ffffff;
            --card: #f0f4f9;
            --text: #1f1f1f;
            --border: #e5e7eb;
            --highlight: #fde047;
            --highlight-text: #000;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        
        .brand {
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #c4c7c5;
            border-radius: 0 20px 20px 0;
            margin-right: 10px;
        }
        .menu-item:hover { background-color: #333; color: #fff; }
        .menu-item.active { background-color: #004a77; color: #c2e7ff; font-weight: 500; }
        .highlight-menu { color: #fbbf24 !important; font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            padding: 20px 40px;
            overflow-y: auto;
            background: #fff;
        }

        .section { display: none; max-width: 950px; margin: 0 auto; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT CARD */
        .card {
            background: #fff;
            border: 1px solid #dadce0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-section-title {
            grid-column: 1 / -1;
            font-size: 12px;
            font-weight: 700;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #3c4043; }
        input, select {
            width: 100%; padding: 10px;
            border: 1px solid #dadce0; border-radius: 4px;
            font-size: 14px; transition: 0.2s;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: #1a73e8; outline: 2px solid rgba(26,115,232,0.2); }

        .btn {
            background: #0b57d0; color: #fff;
            padding: 12px; border: none; border-radius: 24px;
            font-weight: 500; cursor: pointer; width: 100%;
            transition: background 0.2s;
        }
        .btn:hover { background: #0842a0; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* --- REPORT STYLES --- */
        .report-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .report-title { font-size: 16px; font-weight: 600; color: #1f1f1f; }
        .status-badge { font-size: 12px; padding: 4px 12px; border-radius: 16px; font-weight: 500; }
        .st-ok { background: #e6f4ea; color: #137333; }
        .st-warn { background: #fef7e0; color: #ea8600; }
        .st-err { background: #fce8e6; color: #c5221f; }

        .calc-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #444746;
            border-left: 3px solid #0b57d0;
            margin-bottom: 12px;
        }

        .citation-trigger {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f1f3f4;
            border-radius: 18px;
            font-size: 12px;
            color: #1f1f1f;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .citation-trigger:hover { background: #e8eaed; border-color: #dadce0; }
        .citation-trigger svg { width: 16px; height: 16px; fill: #5f6368; }

        /* --- CALCULATION TABLES --- */
        .calc-table {
            width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 13px;
        }
        .calc-table th { background: #f1f3f4; padding: 8px; border: 1px solid #dadce0; text-align: left; color: #444; }
        .calc-table td { padding: 6px; border: 1px solid #dadce0; }
        .calc-table input { width: 100%; border: 1px solid #eee; padding: 4px; box-sizing: border-box; }
        .calc-table input:focus { border-color: #1a73e8; }
        
        .table-controls {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .btn-small {
            background: #fff; border: 1px solid #dadce0; padding: 4px 12px; border-radius: 16px;
            font-size: 12px; cursor: pointer; color: #1f1f1f; width: auto; display: inline-block;
        }
        .btn-small:hover { background: #f1f3f4; }
        .btn-add { color: #0b57d0; border-color: #d3e3fd; background: #e8f0fe; }
        
        .summary-row td { font-weight: bold; background: #f8f9fa; }
        .del-btn { color: #c5221f; cursor: pointer; font-weight: bold; text-align: center; }

        /* --- DOCUMENT VIEWER MODAL (GEMINI STYLE) --- */
        .doc-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        
        .doc-modal {
            background: #f0f2f5;
            width: 95%; max-width: 1100px; height: 95vh;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        .doc-header {
            background: #fff;
            padding: 12px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .doc-title { font-weight: 600; color: #444746; font-size: 14px; }
        .close-btn { cursor: pointer; padding: 8px; border-radius: 50%; border: none; background: none; }
        .close-btn:hover { background: #f1f3f4; }

        .doc-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: center;
            background: #525659; /* M√†u n·ªÅn gi·ªëng tr√¨nh ƒë·ªçc PDF */
        }

        /* GROUP OF PAGES FOR ONE BASIS */
        .citation-group {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 40px;
            border-bottom: 2px dashed #777;
        }
        
        .citation-group-title {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            background: #333;
            padding: 8px 16px;
            border-radius: 4px;
            align-self: flex-start;
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* TRANG GI·∫§Y GI·∫¢ L·∫¨P */
        .doc-page {
            background: #fff;
            width: 100%; 
            min-height: 1000px; /* T·ª∑ l·ªá A4 */
            padding: 50px 60px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            box-sizing: border-box;
            font-family: 'Merriweather', serif; /* Font gi·ªëng vƒÉn b·∫£n in */
            font-size: 14px;
            line-height: 1.6;
            color: #202124;
            position: relative;
        }

        .doc-page-number {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            font-size: 12px; color: #9aa0a6; font-family: sans-serif;
        }
        
        .doc-page-header-text {
            position: absolute; top: 30px; right: 60px;
            font-size: 10px; color: #9aa0a6; text-transform: uppercase; font-family: sans-serif;
        }

        .page-label {
            position: absolute; top: -25px; left: 0;
            background: #444; color: #fff;
            padding: 4px 8px; border-radius: 4px 4px 0 0;
            font-size: 11px; font-family: sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .page-label.is-center { background: #b91c1c; font-weight: bold; }

        /* HIGHLIGHT STYLES */
        mark.highlight {
            background-color: rgba(253, 224, 71, 0.6); /* V√†ng nh·∫°t */
            color: #000;
            padding: 2px 0;
            border-bottom: 2px solid #f59e0b; /* G·∫°ch ch√¢n ƒë·∫≠m */
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: visible; }
            .sidebar { width: 100%; height: auto; }
            .main-content { padding: 15px; }
            .doc-body { padding: 10px; }
            .doc-page { padding: 20px; min-height: auto; }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="brand"><span>üî•</span> PCCC PRO</div>
    
    <div style="padding: 15px 20px 5px; font-size: 11px; font-weight: 700; color: #8e918f;">C√îNG C·ª§ CH√çNH</div>
    <div class="menu-item" onclick="showTab('tong-hop', this)">üìã T·ªïng h·ª£p & Ki·ªÉm tra</div>

    <div style="padding: 15px 20px 5px; font-size: 11px; font-weight: 700; color: #8e918f;">TRA C·ª®U & T√çNH TO√ÅN</div>
    <div class="menu-item" onclick="showTab('nhom-nha', this)">üîç Nh√≥m nh√† (F)</div>
    <div class="menu-item" onclick="showTab('bac-chiu-lua', this)">üèóÔ∏è B·∫≠c Ch·ªãu L·ª≠a</div>
    <div class="menu-item active highlight-menu" onclick="showTab('thoat-nan', this)">üèÉ T√≠nh Tho√°t N·∫°n (Chi ti·∫øt)</div>
    <div class="menu-item" onclick="showTab('cau-kien', this)">üß± C·∫•u ki·ªán (B·∫£ng 1)</div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

    <!-- DASHBOARD T·ªîNG H·ª¢P -->
    <div id="tong-hop" class="section">
        <h2 style="margin-top:0">Ki·ªÉm tra T·ªïng quan</h2>
        <div class="card">
            <p>S·ª≠ d·ª•ng tab n√†y ƒë·ªÉ ki·ªÉm tra nhanh B·∫≠c ch·ªãu l·ª≠a v√† Kho·∫£ng c√°ch. ƒê·ªÉ t√≠nh to√°n s·ªë ng∆∞·ªùi chi ti·∫øt, vui l√≤ng qua tab <strong>T√≠nh Tho√°t N·∫°n</strong>.</p>
            <div class="form-grid">
                 <div><label>Chi·ªÅu cao (m):</label><input type="number" id="inp-height" placeholder="18.5"></div>
                 <div><label>C√¥ng nƒÉng:</label>
                    <select id="inp-function">
                        <option value="F1.3">F1.3 - Chung c∆∞</option>
                        <option value="F4.3">F4.3 - VƒÉn ph√≤ng</option>
                    </select>
                 </div>
            </div>
            <br>
            <button class="btn" onclick="runCheckAll()">KI·ªÇM TRA NHANH</button>
        </div>
        <div id="report-container"></div>
    </div>

    <!-- TAB 3: T√çNH TO√ÅN THO√ÅT N·∫†N CHI TI·∫æT (T√çCH H·ª¢P) -->
    <div id="thoat-nan" class="section active">
        <h2>B·∫£ng t√≠nh M·∫≠t ƒë·ªô & Kh·∫£ nƒÉng tho√°t n·∫°n</h2>
        
        <!-- PH·∫¶N 1: T√çNH S·ªê NG∆Ø·ªúI -->
        <div class="card">
            <div class="form-section-title">1. B·∫£ng t√≠nh M·∫≠t ƒë·ªô ng∆∞·ªùi (Occupancy Load)</div>
            <div style="font-size:13px; color:#555; margin-bottom:10px;">
                Nguy√™n t·∫Øc: <code>S·ªë ng∆∞·ªùi = Di·ªán t√≠ch / H·ªá s·ªë (m¬≤/ng∆∞·ªùi)</code>
            </div>
            
            <table class="calc-table" id="room-table">
                <thead>
                    <tr>
                        <th>T√™n ph√≤ng / Khu v·ª±c</th>
                        <th width="120">Di·ªán t√≠ch (m¬≤)</th>
                        <th width="120">H·ªá s·ªë (m¬≤/ng∆∞·ªùi)</th>
                        <th width="100">S·ªë ng∆∞·ªùi</th>
                        <th width="40"></th>
                    </tr>
                </thead>
                <tbody id="room-tbody">
                    <!-- Rows added by JS -->
                </tbody>
                <tfoot>
                    <tr class="summary-row">
                        <td colspan="3" style="text-align:right;">T·ªïng s·ªë ng∆∞·ªùi c·∫ßn tho√°t n·∫°n:</td>
                        <td id="total-people" style="color:#b91c1c; font-size:16px;">0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <div class="table-controls">
                <button class="btn-small btn-add" onclick="addRoomRow()">+ Th√™m ph√≤ng</button>
            </div>
        </div>

        <!-- PH·∫¶N 2: T√çNH KH·∫¢ NƒÇNG THO√ÅT N·∫†N -->
        <div class="card">
            <div class="form-section-title">2. B·∫£ng t√≠nh Kh·∫£ nƒÉng tho√°t n·∫°n (Egress Capacity)</div>
            <div style="font-size:13px; color:#555; margin-bottom:10px;">
                Nguy√™n t·∫Øc: <code>Kh·∫£ nƒÉng = Chi·ªÅu r·ªông / H·ªá s·ªë d√≤ng ch·∫£y</code>. Kh·∫£ nƒÉng c·ªßa l·ªëi ra = Min(C·ª≠a, Thang).
            </div>
            <div style="display:flex; gap:20px; margin-bottom:15px; background:#f8f9fa; padding:10px; border-radius:4px;">
                <div><label style="font-size:12px">H·ªá s·ªë C·ª≠a (m/ng∆∞·ªùi):</label><input type="number" id="factor-door" value="0.005" step="0.001" onchange="recalcAll()"></div>
                <div><label style="font-size:12px">H·ªá s·ªë Thang (m/ng∆∞·ªùi):</label><input type="number" id="factor-stair" value="0.0076" step="0.0001" onchange="recalcAll()"></div>
                <div style="align-self:end; font-size:12px; color:#666;">(0.005 ~ 200 ng∆∞·ªùi/m; 0.0076 ~ 131 ng∆∞·ªùi/m)</div>
            </div>

            <table class="calc-table" id="exit-table">
                <thead>
                    <tr>
                        <th>T√™n L·ªëi tho√°t (Exit)</th>
                        <th width="100">R·ªông Thang (m)</th>
                        <th width="100">R·ªông C·ª≠a (m)</th>
                        <th width="80">KN Thang</th>
                        <th width="80">KN C·ª≠a</th>
                        <th width="100" style="background:#e6f4ea">Kh·∫£ nƒÉng TT</th>
                        <th width="40"></th>
                    </tr>
                </thead>
                <tbody id="exit-tbody">
                    <!-- Rows added by JS -->
                </tbody>
                <tfoot>
                    <tr class="summary-row">
                        <td colspan="5" style="text-align:right;">T·ªïng kh·∫£ nƒÉng tho√°t n·∫°n cung c·∫•p:</td>
                        <td id="total-capacity" style="color:#137333; font-size:16px;">0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <div class="table-controls">
                <button class="btn-small btn-add" onclick="addExitRow()">+ Th√™m l·ªëi tho√°t</button>
            </div>
        </div>

        <!-- PH·∫¶N 3: K·∫æT LU·∫¨N -->
        <div class="report-card" id="egress-result-card" style="display:none">
            <div class="report-header">
                <div class="report-title">3. K·∫øt qu·∫£ ki·ªÉm tra</div>
                <div class="status-badge" id="egress-status-badge">...</div>
            </div>
            <div id="egress-result-msg"></div>
            <div style="margin-top:12px; border-top:1px solid #f0f0f0; padding-top:10px;">
                 <div class="citation-trigger" onclick="openDocViewerForEgress()">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    <span>Xem cƒÉn c·ª© ph√°p l√Ω (QCVN 06:2022 - M·ª•c 3)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Placeholders for other tabs -->
    <div id="nhom-nha" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u nh√≥m nh√†...</div></div>
    <div id="bac-chiu-lua" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u b·∫≠c ch·ªãu l·ª≠a...</div></div>
    <div id="cau-kien" class="section"><div class="card">T√≠nh nƒÉng tra c·ª©u c·∫•u ki·ªán...</div></div>
</div>

<!-- DOCUMENT VIEWER MODAL -->
<div id="doc-modal" class="doc-modal-overlay">
    <div class="doc-modal">
        <div class="doc-header">
            <div class="doc-title">üìÑ QCVN 06:2022/BXD - TR√åNH XEM CƒÇN C·ª® PH√ÅP L√ù</div>
            <button class="close-btn" onclick="closeDocViewer()">‚úï</button>
        </div>
        <div class="doc-body" id="doc-viewer-content">
            <!-- Pages will be injected here -->
        </div>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
    // --- D·ªÆ LI·ªÜU VƒÇN B·∫¢N G·ªêC ---
    const qcvnPages = {
        38: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.2.4.</strong> Chi·ªÅu r·ªông t·ªïng c·ªông c·ªßa v·∫ø thang, l·ªëi ƒëi tr√™n ƒë∆∞·ªùng tho√°t n·∫°n... ƒë∆∞·ª£c x√°c ƒë·ªãnh t√πy thu·ªôc v√†o s·ªë l∆∞·ª£ng ng∆∞·ªùi... nh∆∞ng kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n gi√° tr·ªã quy ƒë·ªãnh:</p><ul><li>Nh√† F1.1: <strong>1,25m</strong></li><li>Nh√† F1.2, F2, F3, F4: <strong>1,00m</strong></li></ul>`,
        39: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.4.1.</strong> Chi·ªÅu r·ªông th·ªßy c·ªßa b·∫£n thang b·ªô... ph·∫£i ƒë∆∞·ª£c t√≠nh to√°n...</p><p>a) C·ª≠a ƒëi: <strong>1.0m</strong> th√¥ng th∆∞·ªùng.</p><p>b) V·∫ø thang: <strong>0.9m</strong> th√¥ng th∆∞·ªùng.</p>`,
        40: `<h4 style="text-align:center">QCVN 06:2022/BXD</h4><p><strong>3.4.2.</strong> Chi·ªÅu r·ªông m·∫∑t b·∫≠c kh√¥ng nh·ªè h∆°n 25cm...</p>`,
        105: `<h4 style="text-align:center">PH·ª§ L·ª§C H</h4><p>B·∫£ng H.4 - S·ªë t·∫ßng gi·ªõi h·∫°n... Chung c∆∞...</p>`,
        106: `<h4 style="text-align:center">PH·ª§ L·ª§C H</h4><p>Ghi ch√∫ b·ªï sung...</p>`
    };

    // --- LOGIC T√çNH TO√ÅN CHI TI·∫æT (TAB 3) ---
    
    // D·ªØ li·ªáu m·∫´u ban ƒë·∫ßu (gi·ªëng file Excel)
    const initialRooms = [
        {name: "H·ªôi tr∆∞·ªùng", area: 306.47, factor: 0.65},
        {name: "B·∫øp", area: 31.0, factor: 9.3},
        {name: "Ph√≤ng h·ªçp 1", area: 92.6, factor: 0.65}
    ];
    
    const initialExits = [
        {name: "L·ªëi tho√°t hi·ªÉm 1", wStair: 1.099, wDoor: 0.882},
        {name: "L·ªëi tho√°t hi·ªÉm 2", wStair: 1.202, wDoor: 0.887}
    ];

    function initTable() {
        initialRooms.forEach(r => addRoomRow(r.name, r.area, r.factor));
        initialExits.forEach(e => addExitRow(e.name, e.wStair, e.wDoor));
        recalcAll();
    }

    function addRoomRow(name="", area="", factor="0.65") {
        const tbody = document.getElementById('room-tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${name}" placeholder="T√™n ph√≤ng"></td>
            <td><input type="number" class="inp-area" value="${area}" oninput="recalcAll()"></td>
            <td><input type="number" class="inp-factor" value="${factor}" oninput="recalcAll()"></td>
            <td class="res-people" style="font-weight:bold; text-align:center">-</td>
            <td><div class="del-btn" onclick="removeRow(this)">‚úï</div></td>
        `;
        tbody.appendChild(tr);
    }

    function addExitRow(name="", wStair="", wDoor="") {
        const tbody = document.getElementById('exit-tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${name}" placeholder="T√™n l·ªëi tho√°t"></td>
            <td><input type="number" class="inp-wstair" value="${wStair}" oninput="recalcAll()"></td>
            <td><input type="number" class="inp-wdoor" value="${wDoor}" oninput="recalcAll()"></td>
            <td class="res-cap-stair" style="text-align:center; color:#666">-</td>
            <td class="res-cap-door" style="text-align:center; color:#666">-</td>
            <td class="res-cap-final" style="text-align:center; font-weight:bold; background:#f0fdf4">-</td>
            <td><div class="del-btn" onclick="removeRow(this)">‚úï</div></td>
        `;
        tbody.appendChild(tr);
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        recalcAll();
    }

    function recalcAll() {
        // 1. Calc Occupancy
        let totalPeople = 0;
        document.querySelectorAll('#room-tbody tr').forEach(tr => {
            const area = parseFloat(tr.querySelector('.inp-area').value) || 0;
            const factor = parseFloat(tr.querySelector('.inp-factor').value) || 1;
            const people = factor > 0 ? Math.ceil(area / factor) : 0; // Round up person
            tr.querySelector('.res-people').textContent = people;
            totalPeople += people;
        });
        document.getElementById('total-people').textContent = totalPeople;

        // 2. Calc Capacity
        let totalCapacity = 0;
        const fDoor = parseFloat(document.getElementById('factor-door').value) || 0.005;
        const fStair = parseFloat(document.getElementById('factor-stair').value) || 0.0076;

        document.querySelectorAll('#exit-tbody tr').forEach(tr => {
            const wStair = parseFloat(tr.querySelector('.inp-wstair').value) || 0;
            const wDoor = parseFloat(tr.querySelector('.inp-wdoor').value) || 0;
            
            // Excel logic: Capacity = Width / Factor
            const capStair = wStair > 0 ? Math.floor(wStair / fStair) : 0;
            const capDoor = wDoor > 0 ? Math.floor(wDoor / fDoor) : 0;
            
            // Bottleneck logic: Min of Door vs Stair
            // Note: If one is 0 (missing), use the other? Or strict min? 
            // Let's assume if Stair is 0 (e.g. ground floor exit), we take Door.
            let finalCap = 0;
            if (capStair > 0 && capDoor > 0) finalCap = Math.min(capStair, capDoor);
            else finalCap = Math.max(capStair, capDoor);

            tr.querySelector('.res-cap-stair').textContent = capStair;
            tr.querySelector('.res-cap-door').textContent = capDoor;
            tr.querySelector('.res-cap-final').textContent = finalCap;
            totalCapacity += finalCap;
        });
        document.getElementById('total-capacity').textContent = totalCapacity;

        // 3. Update Result Card
        const resCard = document.getElementById('egress-result-card');
        const badge = document.getElementById('egress-status-badge');
        const msg = document.getElementById('egress-result-msg');
        
        resCard.style.display = 'block';
        if (totalPeople === 0) {
             badge.className = 'status-badge st-warn';
             badge.textContent = 'CH∆ØA C√ì D·ªÆ LI·ªÜU';
             msg.innerHTML = 'Vui l√≤ng nh·∫≠p di·ªán t√≠ch ph√≤ng.';
             return;
        }

        if (totalCapacity >= totalPeople) {
            badge.className = 'status-badge st-ok';
            badge.textContent = 'ƒê·∫†T Y√äU C·∫¶U';
            msg.innerHTML = `<div style="color:#137333">T·ªïng kh·∫£ nƒÉng tho√°t n·∫°n (${totalCapacity}) ‚â• T·ªïng s·ªë ng∆∞·ªùi (${totalPeople}).<br>D∆∞ th·ª´a: ${totalCapacity - totalPeople} ng∆∞·ªùi.</div>`;
        } else {
            badge.className = 'status-badge st-err';
            badge.textContent = 'KH√îNG ƒê·∫†T';
            msg.innerHTML = `<div style="color:#c5221f">T·ªïng kh·∫£ nƒÉng tho√°t n·∫°n (${totalCapacity}) < T·ªïng s·ªë ng∆∞·ªùi (${totalPeople}).<br>Thi·∫øu: ${totalPeople - totalCapacity} ng∆∞·ªùi.<br>C·∫ßn m·ªü r·ªông c·ª≠a ho·∫∑c thang.</div>`;
        }
    }

    // --- DOCUMENT VIEWER LOGIC (MULTI-CITATION) ---
    function openDocViewerForEgress() {
        openDocViewer([
            { page: 38, label: 'M·ª•c 3.2.4 (ƒê·ªãnh m·ª©c ng∆∞·ªùi)', highlights: ["s·ªë l∆∞·ª£ng ng∆∞·ªùi", "1,00m", "0,80m"] },
            { page: 39, label: 'M·ª•c 3.4.1 (Chi·ªÅu r·ªông t·ªëi thi·ªÉu)', highlights: ["1,2 m", "1,0 m", "0,9 m"] }
        ]);
    }

    function openDocViewer(citations) {
        const modal = document.getElementById('doc-modal');
        const content = document.getElementById('doc-viewer-content');
        content.innerHTML = '';

        citations.forEach((cit, idx) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'citation-group';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'citation-group-title';
            titleDiv.innerText = `CƒÇN C·ª® ${idx + 1}: ${cit.label}`;
            groupDiv.appendChild(titleDiv);

            [cit.page - 1, cit.page, cit.page + 1].forEach((pageNum, pIdx) => {
                const pageData = qcvnPages[pageNum] || `<div style="text-align:center; color:#999; padding-top:50px">(Trang ${pageNum})</div>`;
                const pageDiv = document.createElement('div');
                pageDiv.className = 'doc-page';
                
                let label = '';
                let labelClass = 'page-label';
                if (pIdx === 1) { label = `TRANG CƒÇN C·ª® (${pageNum})`; labelClass += ' is-center'; }
                else label = `TRANG ${pIdx === 0 ? 'TR∆Ø·ªöC' : 'SAU'} (${pageNum})`;

                let htmlContent = pageData;
                if (pIdx === 1 && cit.highlights) {
                    cit.highlights.forEach(kw => {
                        try { htmlContent = htmlContent.replace(new RegExp(`(${kw})`, 'gi'), '<mark class="highlight">$1</mark>'); } catch(e){}
                    });
                }

                pageDiv.innerHTML = `<div class="${labelClass}">${label}</div><div class="doc-page-header-text">QCVN 06:2022</div>${htmlContent}<div class="doc-page-number">Trang ${pageNum}</div>`;
                groupDiv.appendChild(pageDiv);
            });
            content.appendChild(groupDiv);
        });
        modal.style.display = 'flex';
    }

    function closeDocViewer() { document.getElementById('doc-modal').style.display = 'none'; }
    function showTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // Init
    initTable();
    
    // Dummy functions for other tabs
    function toggleRiskInput() {}
    function runCheckAll() { alert("Vui l√≤ng s·ª≠ d·ª•ng tab 'T√≠nh Tho√°t N·∫°n' ƒë·ªÉ xem t√≠nh nƒÉng m·ªõi."); }

</script>

</body>
</html>
